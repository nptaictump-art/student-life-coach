{% extends "base.html" %}
{% block content %}
<div class="max-w-6xl mx-auto py-10 px-4">
    <!-- Header -->
    <div class="text-center mb-10">
        <h1 class="text-4xl font-extrabold text-indigo-700 mb-2 flex items-center justify-center gap-2">
            🎓 Student Life Coach
        </h1>
        <p class="text-gray-600">Học đều – Đạt điểm cao – Giữ lửa đam mê! 🌟</p>
    </div>

    <!-- User stats -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
        <div class="bg-white rounded-2xl shadow-lg p-6 text-center border-t-4 border-yellow-400">
            <div class="text-4xl font-bold text-yellow-500 mb-2">{{ user.streak }} 🔥</div>
            <p class="text-gray-700 font-medium">Chuỗi ngày học</p>
        </div>
        <div class="bg-white rounded-2xl shadow-lg p-6 text-center border-t-4 border-green-500">
            <div class="text-4xl font-bold text-green-600 mb-2">{{ user.total_points }} 🏆</div>
            <p class="text-gray-700 font-medium">Tổng điểm</p>
        </div>
        <div class="bg-white rounded-2xl shadow-lg p-6 text-center border-t-4 border-blue-500">
            <div class="text-4xl font-bold text-blue-600 mb-2">{{ completion_rate }}%</div>
            <p class="text-gray-700 font-medium">Hoàn thành tuần này</p>
        </div>
    </div>

    <!-- Google Calendar Connection -->
    <div class="text-center mb-8">
        {% if authenticated %}
            <div class="flex justify-center items-center gap-4 mb-4">
                <i class="fa-solid fa-calendar-check text-green-600 text-2xl"></i>
                <span class="text-lg font-semibold text-green-700">
                    ✅ Đã kết nối Google Calendar ({{ session.google_email }})
                </span>
            </div>
            <a href="{{ url_for('logout_google') }}"
               class="inline-flex items-center bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-full shadow-md transition transform hover:scale-105">
               <i class="fa-solid fa-right-from-bracket mr-2"></i> Ngắt kết nối
            </a>
        {% else %}
            <div class="flex justify-center items-center gap-4 mb-4">
                <i class="fa-regular fa-calendar-xmark text-yellow-500 text-2xl"></i>
                <span class="text-lg font-semibold text-yellow-600">
                    ⚠️ Chưa kết nối Google Calendar
                </span>
            </div>
            <a href="{{ url_for('authorize') }}"
               class="inline-flex items-center bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-full shadow-md transition transform hover:scale-105">
               <i class="fa-brands fa-google mr-2"></i> 🔗 Kết nối Google Calendar
            </a>
        {% endif %}
    </div>

    <!-- Weekly Events -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-10">
        <div class="flex items-center gap-2 mb-4">
            <i class="fa-solid fa-calendar-week text-indigo-600 text-2xl"></i>
            <h2 class="text-2xl font-bold text-indigo-700">📅 Lịch học & sự kiện trong 7 ngày tới</h2>
        </div>

        {% if events %}
            <ul class="divide-y divide-gray-200">
                {% for event in events %}
                    <li class="py-4 flex justify-between items-center">
                        <div>
                            <p class="font-semibold text-gray-800">
                                {{ event.summary or "(Không có tiêu đề)" }}
                            </p>
                            {% if event.start.dateTime %}
                                <p class="text-sm text-gray-500">
                                    {{ event.start.dateTime|replace("T", " ")|replace("Z", "") }}
                                    → {{ event.end.dateTime|replace("T", " ")|replace("Z", "") }}
                                </p>
                            {% else %}
                                <p class="text-sm text-gray-500">
                                    {{ event.start.date }} (Cả ngày)
                                </p>
                            {% endif %}
                        </div>
                        <a href="{{ event.htmlLink }}" target="_blank"
                           class="text-indigo-600 hover:text-indigo-800 text-sm font-semibold flex items-center gap-1">
                            Xem <i class="fa-solid fa-arrow-up-right-from-square"></i>
                        </a>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-gray-500 italic text-center py-6">
                Không có sự kiện nào trong tuần này. Hãy thêm lịch học mới nhé! ✏️
            </p>
        {% endif %}
    </div>

    <!-- Chart: 7-day progress -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-10">
        <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
            <i class="fa-solid fa-chart-column text-indigo-500"></i>
            Tiến độ học tập 7 ngày qua
        </h2>
        <canvas id="progressChart" height="100"></canvas>
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-col md:flex-row justify-center gap-6 mt-8">
        <a href="{{ url_for('add_event') }}"
           class="inline-flex items-center bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-8 py-3 rounded-full shadow-md transition transform hover:scale-105">
           <i class="fa-solid fa-calendar-plus mr-2"></i> ➕ Thêm Lịch Học
        </a>

        <a href="{{ url_for('mark_complete') }}"
           class="inline-flex items-center bg-green-600 hover:bg-green-700 text-white font-semibold px-8 py-3 rounded-full shadow-md transition transform hover:scale-105">
           <i class="fa-solid fa-fire mr-2"></i> Đánh Dấu Hoàn Thành
        </a>

        <a href="{{ url_for('generate_quiz') }}"
           class="inline-flex items-center bg-purple-600 hover:bg-purple-700 text-white font-semibold px-8 py-3 rounded-full shadow-md transition transform hover:scale-105">
           <i class="fa-solid fa-question mr-2"></i> 🧠 Làm Quiz AI
        </a>
    </div>

    <!-- Upload Excel Section -->
    {% if authenticated %}
    <div class="mt-10 text-center text-gray-700 bg-indigo-50 rounded-xl py-6 shadow-inner">
        <p class="text-lg font-semibold mb-2 text-indigo-700">📤 Tạo lịch học tự động</p>
        <p>
            <a href="{{ url_for('upload') }}"
               class="text-indigo-600 hover:text-indigo-800 underline font-medium">Tải file Excel để tạo lịch học tự động</a>
        </p>
        <p>
            <a href="{{ url_for('download_template') }}"
               class="text-indigo-600 hover:text-indigo-800 underline font-medium">📄 Tải mẫu Excel import lịch học</a>
        </p>
    </div>
    {% endif %}

    <!-- Encouragement -->
    <div class="mt-10 text-center text-gray-700">
        {% if user.streak >= 7 %}
            <p class="text-lg font-semibold text-green-600 animate-bounce">
                🌟 Tuyệt vời! Bạn đã học đều 7 ngày rồi!
            </p>
        {% elif user.streak > 0 %}
            <p class="text-lg">🚀 Tiếp tục nhé! Còn {{ 7 - user.streak }} ngày nữa để đạt streak vàng!</p>
        {% else %}
            <p class="text-lg text-red-500">🔥 Bắt đầu chuỗi học ngay hôm nay để nhận điểm thưởng!</p>
        {% endif %}
    </div>
</div>

<!-- Chart.js -->
<script>
// Chuyển dữ liệu từ Jinja2 sang JavaScript một cách an toàn
const chartDays = {{ days|tojson|safe }};
const chartCounts = {{ counts|tojson|safe }};

const ctx = document.getElementById('progressChart').getContext('2d');
new Chart(ctx, {
    type: 'bar',
    data: {
        labels: chartDays,
        datasets: [{
            label: 'Số buổi học',
            data: chartCounts,
            backgroundColor: '#6366f1',
            borderColor: '#4f46e5',
            borderWidth: 1,
            borderRadius: 8
        }]
    },
    options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
            y: {
                beginAtZero: true,
                ticks: { stepSize: 1 },
                grid: { color: '#e5e7eb' }
            },
            x: { grid: { display: false } }
        }
    }
});
</script>
{% endblock %}